<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css" rel="stylesheet" />
    <link href="./styles.css" rel="stylesheet" />
</head>
<body>
<div id="map" style="width:1024px; height:768px"></div>
<script>
var map;
var markers = [];
function init(){
mapboxgl.accessToken = 'pk.eyJ1IjoidGhlZGFkYXMxMzEzIiwiYSI6ImNrdXNrOXdwbTB3M2Uybm82d2V1bXljbjgifQ.Qk2kDT-hQODQFqGghcr4lQ';
	var element = document.getElementById('map');
	map = new mapboxgl.Map({
  		container: 'map',
  		style: 'mapbox://styles/mapbox/dark-v10',
  		center: [-71.104081, 42.365554],
  		zoom: 14,
	});
  	addMarkers();
}
async function addMarkers(){
	var locations = await getBusLocations();
	locations.forEach(function(bus){
		var marker = getMarker(bus.id);		
		if (marker){
			moveMarker(marker,bus);
		}
		else{
			addMarker(bus);			
		}
	});
	console.log(new Date());
	setTimeout(addMarkers,15000);
}
async function getBusLocations(){
	var url = 'https://api-v3.mbta.com/vehicles?&filter[route]=1&include=trip';	
	var response = await fetch(url);
	var json     = await response.json();
	return json.data;
}
function addMarker(bus){
	var icon = getIcon(bus);
	var marker = new mapboxgl.Marker({
		color: "#18fc03"
	})
	marker.setLngLat([bus.attributes.longitude, bus.attributes.latitude]);
	marker._element.id = bus.id;
	marker.addTo(map);
	markers.push(marker);
}
function getIcon(bus){
	if (bus.attributes.direction_id === 0) {
		return 'red.png';
	}
	return 'blue.png';	
}
function moveMarker(marker,bus) {
	//if(bus.attributes.direction_id === 0)
    	marker.setLngLat([bus.attributes.longitude,bus.attributes.latitude]);
}
function getMarker(id){
	var marker = markers.find(function(item){
		return item._element.id === id;
	});
	return marker;
}

window.onload = init;
</script>
</body>
</html>
